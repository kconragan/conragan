{{ define "content" }}
<article class="container page gallery">
  <nav id="paginate">
    <div class="inner">
      {{ $pages := .CurrentSection.Pages.ByWeight.Reverse }}
      <a
        href="{{ with $pages.Prev . }}{{ .RelPermalink }}{{ end }}"
        id="prevLink"
        class="arrow left"
        {{
        if
        not
        ($pages.Prev
        .)
        }}style="pointer-events: none"
        {{
        end
        }}
        >Previous</a
      >
      <a
        href="{{ with $pages.Next . }}{{ .RelPermalink }}{{ end }}"
        id="nextLink"
        class="arrow right"
        {{
        if
        not
        ($pages.Next
        .)
        }}style="pointer-events: none"
        {{
        end
        }}
        >Next</a
      >
    </div>
  </nav>
  <div id="imgFrame" class="gallery">
    {{- $image := .Resources.GetMatch "*.jpg*" }} {{- with $image }}
    <img src="{{ .RelPermalink }}" alt="{{ .Title }}" />
    {{ end }}

    <section id="metadata">
      <h1 class="photo-title">{{ .Title }}</h1>

      <!-- Render JSON file -->
      {{- $json := .Resources.GetMatch "*.json*" }}

      <!-- itereate over json -->
      {{- with $json }}

      <!-- using the metadata -->
      {{- $metadata := unmarshal .Content }} {{- with index $metadata 0 }}
      <p class="exif" style="display: none">
        {{- with or (index $metadata 0 "Make") (index $metadata 0 "EXIF:Make")
        -}} {{- $make := . -}} {{- with or (index $metadata 0 "Model") (index
        $metadata 0 "EXIF:Model") -}}
        <em>Camera:</em> {{ $make }} {{ . }} | {{- end -}} {{- end -}} {{- with
        or (index $metadata 0 "LensModel") (index $metadata 0 "EXIF:LensModel")
        }} <em>Lens:</em> {{ . }} | {{- end }} {{- with or (index $metadata 0
        "FocalLength") (index $metadata 0 "EXIF:FocalLength") }}
        <em>Focal length:</em> {{ . }} | {{- end }} {{- with or (index $metadata
        0 "FNumber") (index $metadata 0 "EXIF:FNumber") }}
        <em>Aperture:</em> Æ’/{{ . }} | {{- end }} {{- with or (index $metadata 0
        "ExposureTime") (index $metadata 0 "EXIF:ExposureTime") }}
        <em>Exposure time:</em> {{ . }} s | {{- end }} {{- with or (index
        $metadata 0 "ISO") (index $metadata 0 "EXIF:ISO") }} <em>ISO:</em> {{ .
        }} {{- end }}
      </p>
    </section>
    {{- end }} {{- end }}
  </div>
</article>

<script>
  // Function to prefetch a page
  function prefetchPage(url) {
    if (url) {
      fetch(url, { rel: "prefetch" });
    }
  }

  // Prefetch previous and next pages on load
  prefetchPage(document.getElementById("prevLink")?.href);
  prefetchPage(document.getElementById("nextLink")?.href);

  // Function to adjust image size
  function adjustImageSize() {
    const imgFrame = document.getElementById("imgFrame");
    const img = imgFrame.querySelector("img");
    const metadata = document.getElementById("metadata");

    if (img.complete) {
      const imageTop = img.getBoundingClientRect().top;
      const imageAndMetadataHeight = img.clientHeight + metadata.clientHeight;
      const availableHeight = window.innerHeight - imageTop;

      if (imageAndMetadataHeight > availableHeight) {
        const newImageHeight = availableHeight - metadata.clientHeight - 24;
        img.style.height = newImageHeight + "px";
        img.style.width = "auto";
      }
    } else {
      img.onload = function () {
        adjustImageSize();
      };
    }
  }

  // Add transition effect (example using fade-in)
  function updateTransition() {
    const article = document.getElementById("imgFrame");
    article.style.visibility = "hidden";
    article.classList.remove("fade-in");
    setTimeout(() => {
      article.classList.add("fade-in");
      article.style.visibility = "visible";
    }, 200);
  }

  // Make the function globally accessible (for debugging)
  window.updateTransition = updateTransition;

  // Function to handle navigation (triggered by click or key press)
  function navigateToPage(url) {
    if (!url) {
      return; // Don't navigate if the URL is null
    }

    const article = document.getElementById("imgFrame");
    article.style.visibility = "hidden";

    fetch(url)
      .then((response) => response.text())
      .then((html) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        // Extract the new imgFrame content, INCLUDING the image and metadata
        const newImgFrame = doc.getElementById("imgFrame").innerHTML;

        // Update the imgFrame with the new content
        article.innerHTML = newImgFrame;

        article.style.visibility = "visible";

        // Update the URL after the content is loaded
        history.pushState(null, "", url);

        // Extract and update the navigation HTML separately
        const newPagination = doc.getElementById("paginate").outerHTML;
        document.getElementById("paginate").outerHTML = newPagination;

        // Adjust image size and apply transition after content update
        const img = article.querySelector("img");
        if (img.complete) {
          adjustImageSize();
          updateTransition();
        } else {
          img.addEventListener("load", () => {
            adjustImageSize();
            updateTransition();
          });
        }

        prefetchPage(getNextPageUrl());
        prefetchPage(getPreviousPageUrl());
      })
      .catch((error) => console.error("Error fetching content:", error));
  }

  // Apply fade-in class and adjust image size on initial page load
  window.addEventListener("load", () => {
    const imgFrame = document.getElementById("imgFrame");
    const img = imgFrame.querySelector("img");

    if (img.complete) {
      adjustImageSize();
    } else {
      img.onload = function () {
        adjustImageSize();
      };
    }

    updateTransition();
  });

  // Handle keydown events
  document.addEventListener("keydown", (event) => {
    if (event.key === "ArrowLeft") {
      const prevLink = document.getElementById("prevLink");
      if (prevLink && !prevLink.style.pointerEvents) {
        // Check if the link is NOT disabled
        navigateToPage(getPreviousPageUrl());
      }
    } else if (event.key === "ArrowRight") {
      const nextLink = document.getElementById("nextLink");
      if (nextLink && !nextLink.style.pointerEvents) {
        // Check if the link is NOT disabled
        navigateToPage(getNextPageUrl());
      }
    }
  });

  document.getElementById("prevLink")?.addEventListener("click", (event) => {
    const prevPageUrl = getPreviousPageUrl();
    if (prevPageUrl) {
      console.log("Previous page URL found:", prevPageUrl);
      navigateToPage(prevPageUrl);
    }
  });

  document.getElementById("nextLink")?.addEventListener("click", (event) => {
    const nextPageUrl = getNextPageUrl();
    if (nextPageUrl) {
      console.log("Next page URL found:", nextPageUrl);
      navigateToPage(nextPageUrl);
    }
  });
  function getPreviousPageUrl() {
    const prevLink = document.getElementById("prevLink");
    // Check if the href is not empty
    return prevLink && prevLink.href !== "" ? prevLink.href : null;
  }

  function getNextPageUrl() {
    const nextLink = document.getElementById("nextLink");
    // Check if the href is not empty
    return nextLink && nextLink.href !== "" ? nextLink.href : null;
  }
</script>

<noscript>
  <style>
    #imgFrame {
      opacity: 1; /* Make the image visible by default */
    }
  </style>
</noscript>
{{ end }}
