---
import Base from '../../layouts/Base.astro';
import { getCollection } from 'astro:content';

// Fetch all public blog posts
const posts = (await getCollection(
  'blog',
  (post) => import.meta.env.DEV || post.data.isPublic === true
))
  // Sort posts by date, newest first
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<Base title="Blog Archives | Kai Conragan">
  <hr class="glyph lighthouse" />
  <ol class="h-feed archive">
    {posts.map((post) => {
      // Format the date for display
      const displayDate = post.data.date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      });
      const isoDate = post.data.date.toISOString();

      return (
        <li>
          <article class="h-entry">
            <h2 class="title p-name">
              {/* Use a ternary operator for cleaner conditional links */}
              {post.data.type === 'link' ? (
                <a
                  href={post.data.link}
                  class="u-url external-link"
                  title="Visit external link"
                  target="_blank" 
                  rel="noopener noreferrer"
                >
                  <span class="icon">&gt;</span>{post.data.title}
                </a>
              ) : (
                <a href={`/blog/${post.slug}/`} title="View post">
                  {post.data.title}
                </a>
              )}
            </h2>
            <p class="post-metadata">
              <time class="dt-published" datetime={isoDate}>{displayDate}</time>
            </p>
          </article>
          <hr class="glyph" />
        </li>
      );
    })}
  </ol>
</Base>
